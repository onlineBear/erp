<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zmqy.erp.mapper.mis.pc.module.sys.columnInfo.ColumnModuleMapper">

    <select id="getColumnAll" parameterType="map" resultType="java.util.Map">
        select DISTINCT hc.menuId,m.menuNo,ml.menuName, isnull(hc.pageTypeNo, dc.pageTypeNo) as pageTypeNo, cl.comName
        as pageTypeName
        from tHeadColumn hc
        full join tDtlColumn dc on dc.menuId = hc.menuId
        join tMenu m on m.id = hc.menuId
        left join tMenuLang ml on ml.menuId=m.id and ml.langId=#{loginLangId}
        left join tCommon c on c.comNo = isnull(hc.pageTypeNo, dc.pageTypeNo)
        left join tCommonLang cl on c.id = cl.comId and cl.langId = #{loginLangId}
        <where>
            <if test="menuNoOrName != null and menuNoOrName != ''">
                and (m.menuNo like #{menuNoOrName} or ml.menuName like #{menuNoOrName})
            </if>
            <if test="pageTypeNo != null and pageTypeNo != ''">
                and (hc.pageTypeNo = #{pageTypeNo} or dc.pageTypeNo = #{pageTypeNo})
            </if>
        </where>
        order by m.menuNo, hc.pageTypeNo
    </select>
    <select id="getHeadDetail" parameterType="map" resultType="java.util.Map">
        select
        hc.id,m.menuNo,m.id as
        menuId,hc.columnNo,hc.pageTypeNo,hc.areHidden,hc.areSysRequired,hc.areUserRequired,hcl.columnName,hc.seq
        from
        tHeadColumn hc
        join tHeadColumnLang hcl on hc.id = hcl.headColumnId
        join tMenu m on m.id = hc.menuId
        where hc.pageTypeNo = #{pageTypeNo}
        and hc.menuId = #{menuId}
        and hcl.langId = #{loginLangId}
        order by hc.seq
    </select>

    <select id="getDtlDetail" parameterType="map" resultType="java.util.Map">
        select dc.id,m.menuNo,m.id as menuId,dc.columnNo,dcl.columnName,dc.dataTypeNo,dc.pageTypeNo,
        dc.areHidden,dc.areSysRequired,dc.areUserRequired,dc.width,dc.alias,dc.seq,dc.formula,dc.arrayNo
        from tDtlColumn dc
        join tDtlColumnLang dcl on dc.id = dcl.dtlColumnId
        join tMenu m on m.id = dc.menuId
        where dc.pageTypeNo = #{pageTypeNo}
        and dc.menuId = #{menuId}
        and dcl.langId = #{loginLangId}
        and dc.arrayNo = #{dtlNo}
        <!--新增参数,将是公式的列和隐藏的列进行排除-->
        <if test="isFormula != null and isFormula!=''">
            and dc.formula = ''
            and dc.areHidden = 0
        </if>
        order by dc.seq
    </select>
    <select id="getLastSeq" parameterType="map" resultType="java.lang.Integer">
        select isnull(max(dc.seq),0) from tDtlColumn dc
        where dc.pageTypeNo = #{pageTypeNo}
        and dc.menuId = #{menuId}
        and dc.arrayNo = #{dtlNo}
    </select>

</mapper>
